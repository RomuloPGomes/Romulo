<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspe√ß√£o OAE - Sistema Offline</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Inspe√ß√£o OAE">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 450px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header h1 { font-size: 1.8em; margin-bottom: 5px; position: relative; z-index: 1; }
        .header p { opacity: 0.9; position: relative; z-index: 1; }
        .main-content { padding: 20px; max-height: 80vh; overflow-y: auto; }
        .section { margin-bottom: 25px; padding: 20px; border-radius: 15px; background: #f8f9fa; border-left: 4px solid #3498db; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-header h3 { margin-bottom: 0; color: #2c3e50; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        select { background: white; cursor: pointer; }
        .btn, .btn-primary, .btn-secondary, .btn-warning, .btn-filter, .btn-location { border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; padding: 12px 25px; font-size: 14px; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; width: 100%; margin-top: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 16px; padding: 15px 30px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; margin-top: 10px; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(231, 76, 60, 0.3); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; margin-top: 10px; }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(243, 156, 18, 0.3); }
        .btn-link { background: #e8f4f8; color: #3498db; text-decoration: none; }
        .btn-link:hover { background: #d1e9f5; }
        .btn-location { background: #9b59b6; color: white; width: 100%; margin-top: -10px; margin-bottom: 15px; }
        .btn-location:hover { background: #8e44ad; }
        .copy-coords { display: flex; gap: 10px; margin-bottom: 15px; }
        .copy-coords input { background-color: #e9ecef; }
        .copy-coords button { padding: 10px 15px; font-size: 12px; flex-shrink: 0; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .btn-filter { padding: 5px 10px; font-size: 12px; background: #e9ecef; color: #495057; }
        .btn-filter.active { background: #3498db; color: white; }
        .registros-list { max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 10px; padding: 10px; margin-top: 15px; }
        .registro-item { background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .registro-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .registro-item-header h4 { color: #2c3e50; margin: 0; font-size: 16px; flex-grow: 1; }
        .registro-item-actions button { font-size: 10px; padding: 4px 8px; margin-left: 4px; border-radius: 15px; flex-shrink: 0;}
        .registro-item p { color: #6c757d; font-size: 13px; margin-bottom: 4px; }
        .tabs { display: flex; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .tab { flex: 1; padding: 15px; background: transparent; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s ease; color: #6c757d; }
        .tab.active { background: #3498db; color: white; }
        .tab:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .icon { font-size: 1.2em; }
        .photo-info { background: #e8f4f8; padding: 15px; border-radius: 10px; border: 1px solid #3498db; margin-top: 15px; }
        .photo-info p { color: #6c757d; font-size: 14px; text-align: center; font-weight: 500;}
        .hidden { display: none; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h2 { color: #2c3e50; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: black; }
        .legenda-table { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px; }
        .legenda-table table { width: 100%; border-collapse: collapse; }
        .legenda-table th, .legenda-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .legenda-table th { background-color: #f2f2f2; font-weight: 600; }
        .footer { text-align: center; padding: 15px; background-color: #f8f9fa; border-top: 1px solid #eee; }
        .footer p { color: #888; font-size: 12px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Inspe√ß√£o OAE</h1>
            <p>Gerenciador Offline de Inspe√ß√µes</p>
            <div id="offlineIndicator" style="display: none; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; margin-top: 10px; font-size: 12px;">
                üì± Funcionando Offline
            </div>
        </div>
        <div class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="inspecoes" onclick="showTab('inspecoes', this)">Inspe√ß√µes</button>
                <button class="tab" data-tab="dados_gerais" onclick="showTab('dados_gerais', this)" disabled>Dados Gerais</button>
                <button class="tab" data-tab="registros" onclick="showTab('registros', this)" disabled>Registros</button>
                <!-- Nova aba Caracter√≠sticas Gerais -->
                <button class="tab" data-tab="caracteristicas_gerais" onclick="showTab('caracteristicas_gerais', this)" disabled>Caracter√≠sticas Gerais</button>
            </div>
            <div id="inspecoes" class="tab-content active">
                <div class="section">
                    <div class="section-header">
                        <h3><span class="icon">üìÇ</span> Gerenciar Inspe√ß√£o</h3>
                    </div>
                    <div class="form-group">
                        <label for="inspecaoAtiva">Selecionar Inspe√ß√£o:</label>
                        <select id="inspecaoAtiva"></select>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-link" id="novaInspecaoBtn">‚ûï Nova Inspe√ß√£o</button>
                        <button type="button" class="btn btn-secondary" id="deletarInspecaoBtn">üóëÔ∏è Deletar Inspe√ß√£o Ativa</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3><span class="icon">üìä</span> Importar/Exportar Dados</h3>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-link" id="downloadTemplateBtn">üì• Baixar Planilha Modelo</button>
                        <button type="button" class="btn btn-link" id="importDataBtn">üì§ Importar Planilha</button>
                    </div>
                    <div id="importStatus" class="form-group" style="display: none;">
                        <p id="importMessage" style="color: #28a745; font-weight: 600; text-align: center; padding: 10px; background: #d4edda; border-radius: 8px;"></p>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3><span class="icon">üìã</span> Lista de Inspe√ß√µes</h3>
                    </div>
                    <div id="inspecoesList" class="registros-list" style="max-height: 300px;">
                        <p style="text-align:center; color:#6c757d; padding: 20px;">Nenhuma inspe√ß√£o criada ainda.</p>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3><span class="icon">üóëÔ∏è</span> Limpar Todas as Inspe√ß√µes</h3>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary" id="deletarTudoBtn">üóëÔ∏è Deletar Todas as Inspe√ß√µes</button>
                    </div>
                </div>
            </div>
            <div id="dados_gerais" class="tab-content">
                 <div class="section">
                    <div class="section-header"><h3><span class="icon">üèóÔ∏è</span> Dados Gerais</h3></div>
                    <div class="form-group"><label for="concessionaria">Nome da Concession√°ria:</label><input type="text" id="concessionaria" required></div>
                    <div class="form-row"><div class="form-group"><label for="rodovia">Rodovia:</label><input type="text" id="rodovia" required></div><div class="form-group"><label for="km">km+m:</label><input type="text" id="km" required></div></div>
                    <div class="form-row"><div class="form-group"><label for="latitude">Latitude:</label><input type="number" id="latitude" step="any" placeholder="-22.9068"></div><div class="form-group"><label for="longitude">Longitude:</label><input type="number" id="longitude" step="any" placeholder="-43.1729"></div></div>
                    <button type="button" class="btn btn-location" id="getCoordsBtn">üìç Obter Coordenadas Atuais</button>
                    <div id="copyCoordsContainer" class="copy-coords hidden"><input type="text" id="coordsForCopy" readonly><button type="button" id="copyCoordsBtn" class="btn btn-link">Copiar</button></div>
                    <div class="form-group"><label for="nome_obra">Nome da Obra:</label><input type="text" id="nome_obra" required></div>
                    <div class="form-row"><div class="form-group"><label for="sentido">Sentido Crescente:</label><select id="sentido" required><option value="">Selecione...</option><option value="Leste">Leste</option><option value="Oeste">Oeste</option><option value="Norte">Norte</option><option value="Sul">Sul</option></select></div><div class="form-group"><label for="data">Data da Inspe√ß√£o:</label><input type="date" id="data" required></div></div>
                    <div class="form-group"><label for="inspetor">Inspetor:</label><input type="text" id="inspetor" required></div>
                </div>
            </div>
            <div id="registros" class="tab-content">
                <form id="inspectionForm">
                    <div class="section">
                        <div class="section-header"><h3><span class="icon">‚ûï</span> Novo Registro</h3></div>
                        <div class="section">
                            <div class="section-header"><h3><span class="icon">üîß</span> Elemento Inspecionado</h3><button type="button" class="btn btn-link" id="abrirModalLegendas">Consultar Legendas</button></div>
                            <div class="form-group"><label for="elemento">Elemento:</label><select id="elemento" name="elemento" required><option value="">Selecione...</option><option value="FOTO CAPA PANOR√ÇMICA">FOTO CAPA PANOR√ÇMICA</option><option value="AA">AA</option><option value="AB">AB</option><option value="AC">AC</option><option value="AD">AD</option><option value="AL">AL</option><option value="ALE">ALE</option><option value="ALI">ALI</option><option value="AP">AP</option><option value="B√á">B√á</option><option value="BL">BL</option><option value="BLC">BLC</option><option value="BLOCO DE ANCORAGEM">BLOCO DE ANCORAGEM</option><option value="BR">BR</option><option value="BU">BU</option><option value="BUZ">BUZ</option><option value="BZ">BZ</option><option value="CABO DE PROTENS√ÉO">CABO DE PROTENS√ÉO</option><option value="CEL">CEL</option><option value="CO">CO</option><option value="DG">DG</option><option value="DI">DI</option><option value="DM">DM</option><option value="DR">DR</option><option value="EB">EB</option><option value="ENC">ENC</option><option value="ET">ET</option><option value="GC">GC</option><option value="GR">GR</option><option value="JANELA">JANELA</option><option value="JD">JD</option><option value="JUNTA JUSANTE">JUNTA JUSANTE</option><option value="L">L</option><option value="LB">LB</option><option value="LI">LI</option><option value="LS">LS</option><option value="LT">LT</option><option value="MF">MF</option><option value="MONTANTE">MONTANTE</option><option value="MT">MT</option><option value="P">P</option><option value="PA">PA</option><option value="PC">PC</option><option value="PF">PF</option><option value="PIL">PIL</option><option value="PINGADEIRA">PINGADEIRA</option><option value="PISTA">PISTA</option><option value="PLACA DE FECHAMENTO">PLACA DE FECHAMENTO</option><option value="PR">PR</option><option value="PS">PS</option><option value="RAMPA">RAMPA</option><option value="SAP">SAP</option><option value="SH-TACHAS REFLETIVAS">SH-TACHAS REFLETIVAS</option><option value="SJ">SJ</option><option value="SV-BARREIRAS">SV-BARREIRAS</option><option value="SV-GABARITO">SV-GABARITO</option><option value="TA">TA</option><option value="TESTEIRA">TESTEIRA</option><option value="TRAVESSIA">TRAVESSIA</option><option value="TRE">TRE</option><option value="TRECHO">TRECHO</option><option value="TUB">TUB</option><option value="TUBO ARMCO">TUBO ARMCO</option><option value="TUBULA√á√ÉO DE UTILIDADES">TUBULA√á√ÉO DE UTILIDADES</option><option value="V">V</option><option value="VA">VA</option><option value="VL">VL</option><option value="VLR">VLR</option><option value="VLT">VLT</option><option value="VT">VT</option><option value="VTR">VTR</option><option value="VTRAV">VTRAV</option><option value="FINAL DE INSPE√á√ÉO">FINAL DE INSPE√á√ÉO</option></select></div>
                            <div class="form-row"><div class="form-group"><label for="numero_elemento">N√∫mero do Elemento:</label><input type="number" id="numero_elemento" name="numero_elemento" min="1" required></div><div class="form-group"><label for="vao">V√£o (Opcional):</label><select id="vao" name="vao"><option value="">N/A</option><script>for(let i=1; i<=50; i++) { document.write(`<option value="V√£o ${String(i).padStart(2, '0')}">V√£o ${String(i).padStart(2, '0')}</option>`); }</script></select></div></div>
                            <div class="form-row"><div class="form-group"><label for="face">Face (Opcional):</label><select id="face" name="face"><option value="">N/A</option><option value="Norte">Norte</option><option value="Sul">Sul</option><option value="Leste">Leste</option><option value="Oeste">Oeste</option><option value="Inferior">Inferior</option><option value="Superior">Superior</option><option value="Sob a Obra">Sob a Obra</option><option value="Sobre a Obra">Sobre a Obra</option></select></div><div class="form-group"><label for="vista">Vista (Opcional):</label><select id="vista" name="vista"><option value="">N/A</option><option value="Norte - Sul">Norte - Sul</option><option value="Sul - Norte">Sul - Norte</option><option value="Leste - Oeste">Leste - Oeste</option><option value="Oeste - Leste">Oeste - Leste</option></select></div></div>
                        </div>
                        <div class="section">
                            <div class="section-header"><h3><span class="icon">‚ö†Ô∏è</span> Anomalias</h3></div>
                            <div class="filter-buttons" id="anomalia-filters"><button type="button" class="btn-filter active" data-category="todos">Todos</button><button type="button" class="btn-filter" data-category="concreto">Concreto</button><button type="button" class="btn-filter" data-category="metalica">Met√°licas</button><button type="button" class="btn-filter" data-category="pavimentacao">Pavim.</button><button type="button" class="btn-filter" data-category="apoios">Apoios</button></div>
                            <div class="form-group"><label for="anomalia">Anomalia (Opcional):</label><select id="anomalia" name="anomalia"><option value="">Selecione...</option><optgroup label="1. CONCRETO"><option data-category="concreto" value="1.1">1.1 - Manchas de umidade</option><option data-category="concreto" value="1.2">1.2 - Manchas de umidade ativa</option><option data-category="concreto" value="1.3">1.3 - Efloresc√™ncia</option><option data-category="concreto" value="1.4">1.4 - Estalactites</option><option data-category="concreto" value="1.5">1.5 - Concreto disgregado</option><option data-category="concreto" value="1.5-1.17">1.5-1.17 - Concreto disgregado com Armadura Exposta</option><option data-category="concreto" value="1.6">1.6 - Concreto segregado</option><option data-category="concreto" value="1.6-1.17">1.6-1.17 - Concreto segregado com Armadura Exposta</option><option data-category="concreto" value="1.7">1.7 - Concreto desagregado</option><option data-category="concreto" value="1.7-1.17">1.7-1.17 - Concreto desagregado com Armadura Exposta</option><option data-category="concreto" value="1.8">1.8 - Redu√ß√£o de cobrimento</option><option data-category="concreto" value="1.9">1.9 - Fissuras horizontais</option><option data-category="concreto" value="1.10">1.10 - Fissuras verticais</option><option data-category="concreto" value="1.11">1.11 - Fissuras diagonais</option><option data-category="concreto" value="1.12">1.12 - Fissuras mapeadas</option><option data-category="concreto" value="1.13">1.13 - Trincas (&gt;0,5 mm)</option><option data-category="concreto" value="1.14">1.14 - Reparos locais inadequados</option><option data-category="concreto" value="1.15">1.15 - Fora de prumo</option><option data-category="concreto" value="1.16">1.16 - Desplacamento</option><option data-category="concreto" value="1.16-1.17">1.16-1.17 - Desplacamento com Armadura Exposta</option><option data-category="concreto" value="1.17">1.17 - Armadura exposta</option><option data-category="concreto" value="1.18">1.18 - Manchas enegrecidas</option><option data-category="concreto" value="1.19">1.19 - Incid√™ncia de vegeta√ß√£o</option><option data-category="concreto" value="1.20">1.20 - Deslocamento linear ou angular</option><option data-category="concreto" value="1.21">1.21 - Resto de forma</option><option data-category="concreto" value="1.22">1.22 - Drenos de inje√ß√£o n√£o arrematados</option><option data-category="concreto" value="1.23">1.23 - Falha no acabamento dos nichos de ancoragens das armaduras protendidas</option></optgroup><optgroup label="2. ESTRUTURAS MET√ÅLICAS"><option data-category="metalica" value="2.1">2.1 - Falha de acabamento na soldagem</option><option data-category="metalica" value="2.2">2.2 - Corros√£o</option><option data-category="metalica" value="2.3">2.3 - Empeno/Deforma√ß√£o</option><option data-category="metalica" value="2.4">2.4 - Falta de parafusos, porcas e arruelas</option><option data-category="metalica" value="2.5">2.5 - Falha de pintura</option><option data-category="metalica" value="2.6">2.6 - Trinca transpassante</option><option data-category="metalica" value="2.7">2.7 - Infiltra√ß√£o no parafuso</option><option data-category="metalica" value="2.8">2.8 - Oxida√ß√£o</option><option data-category="metalica" value="2.9">2.9 - Buzinotes curtos, danificados ou ausentes</option><option data-category="metalica" value="2.10">2.10 - Calcina√ß√£o</option></optgroup><optgroup label="3. PAVIMENTA√á√ÉO E SISTEMA VI√ÅRIO"><option data-category="pavimentacao" value="3.1">3.1 - Fuga de material, exist√™ncia de eros√£o e ind√≠cios de instabilidade do talude</option><option data-category="pavimentacao" value="3.2">3.2 - Desgaste superficial, espessura excessiva, ondula√ß√µes e cavidades no pavimento</option><option data-category="pavimentacao" value="3.3">3.3 - Defici√™ncia e/ou aus√™ncia de sinaliza√ß√£o horizontal, vertical e a√©rea</option><option data-category="pavimentacao" value="3.4">3.4 - Descontinuidade do greide</option><option data-category="pavimentacao" value="3.5">3.5 - Defici√™ncia no sistema de drenagem</option><option data-category="pavimentacao" value="3.6">3.6 - Aus√™ncia de perfil de veda√ß√£o na junta de dilata√ß√£o</option><option data-category="pavimentacao" value="3.7">3.7 - Falta de estanqueidade na junta de dilata√ß√£o</option><option data-category="pavimentacao" value="3.8">3.8 - Sali√™ncia ou depress√£o causando desconforto ao usu√°rio ou impacto na obra</option><option data-category="pavimentacao" value="3.9">3.9 - Deteriora√ß√£o dos l√°bios polim√©ricos</option><option data-category="pavimentacao" value="3.10">3.10 - Deteriora√ß√£o dos ber√ßos na junta de dilata√ß√£o</option><option data-category="pavimentacao" value="3.11">3.11 - Ac√∫mulo de detritos na junta de dilata√ß√£o</option><option data-category="pavimentacao" value="3.12">3.12 - Perfil elastom√©rico com descolamento, rasgos ressecamento ou deslocamento</option><option data-category="pavimentacao" value="3.13">3.13 - Abertura excessiva da junta de dilata√ß√£o</option><option data-category="pavimentacao" value="3.14">3.14 - Trincas</option><option data-category="pavimentacao" value="3.15">3.15 - Fissuras</option><option data-category="pavimentacao" value="3.16">3.16 - Panela</option><option data-category="pavimentacao" value="3.17">3.17 - Exsuda√ß√£o</option><option data-category="pavimentacao" value="3.18">3.18 - Defeitos nos trilhos (ondula√ß√µes e desgastes)</option><option data-category="pavimentacao" value="3.19">3.19 - Falha de adensamento do lastro</option><option data-category="pavimentacao" value="3.20">3.20 - Dormentes soltos, ausentes ou danificados</option><option data-category="pavimentacao" value="3.21">3.21 - Fixa√ß√µes danificadas</option><option data-category="pavimentacao" value="3.22">3.22 - Trilhos desalinhados em regi√£o de junta</option><option data-category="pavimentacao" value="3.23">3.23 - Espessura excessiva do lastro</option><option data-category="pavimentacao" value="3.24">3.24 - Trincas tipo "couro de jacar√©"</option><option data-category="pavimentacao" value="3.25">3.25 - Dano em pavimento r√≠gido</option></optgroup><optgroup label="4. APARELHOS DE APOIO"><option data-category="apoios" value="4.1">4.1 - Aus√™ncia de aparelho de apoio</option><option data-category="apoios" value="4.2">4.2 - Bloqueio</option><option data-category="apoios" value="4.3">4.3 - Posicionamento inadequado</option><option data-category="apoios" value="4.4">4.4 - Ac√∫mulo de detritos, ocorr√™ncia de agentes agressivos</option><option data-category="apoios" value="4.5">4.5 - Ruptura</option><option data-category="apoios" value="4.6">4.6 - Fissuras</option><option data-category="apoios" value="4.7">4.7 - Trincas</option><option data-category="apoios" value="4.8">4.8 - Esmagamento</option><option data-category="apoios" value="4.9">4.9 - Deforma√ß√µes laterais excessivas</option><option data-category="apoios" value="4.10">4.10 - Deslocamentos</option><option data-category="apoios" value="4.11">4.11 - Distor√ß√£o excessiva</option><option data-category="apoios" value="4.12">4.12 - Pe√ßas de a√ßo oxidadas e expostas</option><option data-category="apoios" value="4.13">4.13 - Descolamento da fretagem</option><option data-category="apoios" value="4.14">4.14 - Assentamento irregular com concentra√ß√£o de esfor√ßos</option><option data-category="apoios" value="4.15">4.15 - Deteriora√ß√£o do ber√ßo de assentamento e de nivelamento superior</option></optgroup></select></div>
                            <div class="form-row"><div class="form-group"><label for="comprimento">Comprimento (m):</label><input type="number" id="comprimento" name="comprimento" step="0.01" min="0"></div><div class="form-group"><label for="largura">Largura (m):</label><input type="number" id="largura" name="largura" step="0.01" min="0"></div></div>
                            <div class="form-group"><label for="abertura">Abertura de Fissuras:</label><select id="abertura" name="abertura"><option value="">Selecione...</option><script> for(let i = 10; i <= 1000; i += 5) { let v = (i / 100).toFixed(2).replace('.', ','); document.write(`<option value="W${v}">W${v}</option>`); } </script></select></div>
                        </div>
                        <div class="section">
                            <div class="section-header"><h3><span class="icon">üì∏</span> Controle de Fotos</h3></div>
                            <div class="form-row"><div class="form-group"><label for="tipo_foto">Tipo de Foto:</label><select id="tipo_foto" name="tipo_foto"><option value="camera">C√¢mera</option><option value="drone">Drone</option></select></div><div class="form-group"><label for="qtdFotos">Quantidade:</label><input type="number" id="qtdFotos" name="qtdFotos" value="2" min="1"></div></div>
                            <div id="contador_camera_group" class="form-group"><label for="fotoInicialCamera">Numera√ß√£o Inicial (C√¢mera):</label><input type="number" id="fotoInicialCamera" min="1"></div>
                            <div id="contador_drone_group" class="form-group hidden"><label for="fotoInicialDrone">Numera√ß√£o Inicial (Drone):</label><input type="number" id="fotoInicialDrone" min="1"></div>
                            <div class="photo-info"><p id="fotoInfo"></p></div><input type="hidden" id="fotoInicial" name="fotoInicial">
                        </div>
                        <div class="section">
                            <div class="section-header"><h3><span class="icon">üìù</span> Observa√ß√µes</h3></div>
                            <div class="form-group"><label for="observacoes">Observa√ß√µes Adicionais:</label><textarea id="observacoes" name="observacoes" rows="3" placeholder="Descri√ß√£o detalhada..."></textarea></div>
                        </div>
                        <button type="submit" id="submitBtn" class="btn btn-primary">üíæ Salvar Registro</button>
                        <button type="button" id="cancelEditBtn" class="btn btn-warning hidden">Cancelar Edi√ß√£o</button>
                    </div>
                </form>
                <hr style="margin-top: 30px; border: 0; border-top: 1px solid #eee;">
                <h3 style="text-align: center; color: #34495e; margin: 20px 0;">Registros da Inspe√ß√£o Ativa</h3>
                <div id="registrosList" class="registros-list"></div>
                <button type="button" id="exportButton" class="btn btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9);">üìÑ Exportar Registros</button>
            </div>
            <!-- Nova aba: Caracter√≠sticas Gerais -->
            <div id="caracteristicas_gerais" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h3><span class="icon">üèóÔ∏è</span> Caracter√≠sticas Gerais da Obra</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="comprimento_total">Comprimento total (m):</label>
                            <input type="number" id="comprimento_total" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="largura_total">Largura total (m):</label>
                            <input type="number" id="largura_total" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="largura_util">Largura √∫til (m):</label>
                            <input type="number" id="largura_util" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="sentido_crescente">Sentido crescente da rodovia:</label>
                            <select id="sentido_crescente">
                                <option value="">Selecione...</option>
                                <option value="Norte">Norte</option>
                                <option value="Sul">Sul</option>
                                <option value="Leste">Leste</option>
                                <option value="Oeste">Oeste</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="qtd_vaos">Quantidade de v√£os:</label>
                            <input type="number" id="qtd_vaos" min="0">
                        </div>
                        <div class="form-group">
                            <label for="pilares">Pilares:</label>
                            <input type="text" id="pilares">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="juntas_dilatacao">Juntas de dilata√ß√£o:</label>
                            <input type="text" id="juntas_dilatacao">
                        </div>
                        <div class="form-group">
                            <label for="vaos_tipo">V√£os‚Äëtipo (isost√°tico, cont√≠nuo):</label>
                            <input type="text" id="vaos_tipo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tabuleiro_tipo">Tabuleiro‚Äëtipo:</label>
                        <input type="text" id="tabuleiro_tipo">
                    </div>
                    <div class="form-group">
                        <label for="tipologia_longitudinal">Tipologia longitudinal (Superestrutura):</label>
                        <select id="tipologia_longitudinal">
                            <option value="">Selecione...</option>
                            <option value="Biapoiado">Biapoiado</option>
                            <option value="Isost√°tica">Isost√°tica</option>
                            <option value="Cont√≠nua">Cont√≠nua</option>
                            <option value="V√£o apoiado em consolo ou dente Gerber">V√£o apoiado em consolo ou dente Gerber</option>
                            <option value="Arco superior">Arco superior</option>
                            <option value="Arco intermedi√°rio">Arco intermedi√°rio</option>
                            <option value="Arco inferior">Arco inferior</option>
                            <option value="P√≥rtico">P√≥rtico</option>
                            <option value="Estaiada">Estaiada</option>
                            <option value="P√™nsil">P√™nsil</option>
                            <option value="Treli√ßa">Treli√ßa</option>
                            <option value="Outra">Outra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipologia_transversal">Tipologia transversal (Superestrutura):</label>
                        <select id="tipologia_transversal">
                            <option value="">Selecione...</option>
                            <option value="Laje">Laje</option>
                            <option value="Duas vigas">Duas vigas</option>
                            <option value="Grelha">Grelha</option>
                            <option value="Se√ß√£o celular">Se√ß√£o celular</option>
                            <option value="Treli√ßa">Treli√ßa</option>
                            <option value="Outras">Outras</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipologia_mesoestrutura">Tipologia da mesoestrutura:</label>
                        <select id="tipologia_mesoestrutura">
                            <option value="">Selecione...</option>
                            <option value="Pilares isolados">Pilares isolados</option>
                            <option value="Pilares com travessa">Pilares com travessa</option>
                            <option value="Pilares contraventados">Pilares contraventados</option>
                            <option value="Pilares parede">Pilares parede</option>
                            <option value="Pilones">Pilones</option>
                            <option value="Outras">Outras</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipologia_infraestrutura">Tipologia da infraestrutura:</label>
                        <select id="tipologia_infraestrutura">
                            <option value="">Selecione...</option>
                            <option value="Funda√ß√£o superficial">Funda√ß√£o superficial</option>
                            <option value="Tubul√µes">Tubul√µes</option>
                            <option value="Estaca escavada">Estaca escavada</option>
                            <option value="Estaca pr√©-moldada">Estaca pr√©-moldada</option>
                            <option value="Estaca met√°lica">Estaca met√°lica</option>
                            <option value="Estaca de madeira">Estaca de madeira</option>
                            <option value="N√£o identificado">N√£o identificado</option>
                            <option value="Outras">Outras</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sistemas_construtivos">Sistemas construtivos:</label>
                        <select id="sistemas_construtivos">
                            <option value="">Selecione...</option>
                            <option value="Moldado no local">Moldado no local</option>
                            <option value="Pr√©-moldado somente armado">Pr√©-moldado somente armado</option>
                            <option value="Pr√©-moldado protendido (p√≥s-tens√£o)">Pr√©-moldado protendido (p√≥s-tens√£o)</option>
                            <option value="Pr√©-moldado protendido (pr√©-tens√£o)">Pr√©-moldado protendido (pr√©-tens√£o)</option>
                            <option value="Balan√ßo sucessivo">Balan√ßo sucessivo</option>
                            <option value="Aduelas pr√©-moldadas">Aduelas pr√©-moldadas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="natureza_transposicao">Natureza da transposi√ß√£o:</label>
                        <select id="natureza_transposicao">
                            <option value="">Selecione...</option>
                            <option value="Superf√≠cie aqu√≠fera">Superf√≠cie aqu√≠fera</option>
                            <option value="Rodovia">Rodovia</option>
                            <option value="Ferrovia">Ferrovia</option>
                            <option value="Vale">Vale</option>
                            <option value="Grota">Grota</option>
                            <option value="Contorno de encosta">Contorno de encosta</option>
                            <option value="Via urbana">Via urbana</option>
                            <option value="Via de pedestre">Via de pedestre</option>
                            <option value="Outras">Outras</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="materiais">Materiais:</label>
                        <select id="materiais">
                            <option value="">Selecione...</option>
                            <option value="Concreto simples (CS)">Concreto simples (CS)</option>
                            <option value="Concreto armado (CA)">Concreto armado (CA)</option>
                            <option value="Concreto protendido (CP)">Concreto protendido (CP)</option>
                            <option value="A√ßo (A)">A√ßo (A)</option>
                            <option value="Madeira (MD)">Madeira (MD)</option>
                            <option value="Pedra argamassada (PA)">Pedra argamassada (PA)</option>
                            <option value="Mista (MI)">Mista (MI)</option>
                            <option value="Alvenaria (AL)">Alvenaria (AL)</option>
                            <option value="N√£o identificado">N√£o identificado</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="qtd_aparelhos_apoio">Quantidade de aparelhos de apoio:</label>
                            <input type="number" id="qtd_aparelhos_apoio" min="0">
                        </div>
                        <div class="form-group">
                            <label for="gabarito_vertical_sob">Gabarito vertical sob a OAE (m):</label>
                            <input type="number" id="gabarito_vertical_sob" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gabarito_vertical_sobre">Gabarito vertical sobre a OAE (m):</label>
                            <input type="number" id="gabarito_vertical_sobre" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="gabarito_navegavel_altura">Gabarito naveg√°vel ‚Äî Altura (m):</label>
                            <input type="number" id="gabarito_navegavel_altura" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="gabarito_navegavel_largura">Gabarito naveg√°vel ‚Äî Largura (m):</label>
                            <input type="number" id="gabarito_navegavel_largura" step="0.01" min="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer"><p>Desenvolvido por: Jo√£o R√¥mulo Gomes</p></footer>
    </div>
    
    <div id="legendaModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Legendas dos Elementos</h2><span class="close-button">&times;</span></div><div class="legenda-table"><table><tr><th>Sigla</th><th>Descri√ß√£o</th></tr><tr><td>AA</td><td>Aparelho de apoio</td></tr><tr><td>AB</td><td>Ab√≥bada</td></tr><tr><td>AC</td><td>Acesso</td></tr><tr><td>AD</td><td>Aduela</td></tr><tr><td>AL</td><td>Muro de ala</td></tr><tr><td>ALE</td><td>Alma externa (caix√£o)</td></tr><tr><td>ALI</td><td>Alma interna (caix√£o)</td></tr><tr><td>AP</td><td>Apoio</td></tr><tr><td>B√á</td><td>Ber√ßo</td></tr><tr><td>BL</td><td>Balan√ßo longitudinal</td></tr><tr><td>BLC</td><td>Bloco de funda√ß√£o</td></tr><tr><td>BR</td><td>Barreira r√≠gida</td></tr><tr><td>BU</td><td>Bueiro</td></tr><tr><td>BUZ</td><td>Buzinote</td></tr><tr><td>BZ</td><td>Banzo</td></tr><tr><td>CEL</td><td>C√©lula</td></tr><tr><td>CO</td><td>Cortina</td></tr><tr><td>DG</td><td>Dente gerber</td></tr><tr><td>DI</td><td>Diagonal</td></tr><tr><td>DM</td><td>Defensa met√°lica</td></tr><tr><td>DR</td><td>Drenagem</td></tr>
<tr><td>EB</td><td>Emboque</td></tr><tr><td>ENC</td><td>Encontro</td></tr><tr><td>ET</td><td>Estaca</td></tr><tr><td>GC</td><td>Guarda-corpos</td></tr><tr><td>GR</td><td>Guarda-rodas</td></tr><tr><td>JD</td><td>Junta de dilata√ß√£o</td></tr><tr><td>LB</td><td>Laje em balan√ßo (transversal)</td></tr></table><table><tr><th>Sigla</th><th>Descri√ß√£o</th></tr><tr><td>LI</td><td>Laje inferior</td></tr><tr><td>LS</td><td>Laje superior</td></tr><tr><td>LT</td><td>Laje de transi√ß√£o</td></tr><tr><td>MF</td><td>Meio-Fio</td></tr><tr><td>MT</td><td>Montante</td></tr><tr><td>P</td><td>Pilar</td></tr><tr><td>PA</td><td>Parede</td></tr><tr><td>PC</td><td>Piso de concreto</td></tr><tr><td>PF</td><td>Pavimento fex√≠vel</td></tr><tr><td>PIL</td><td>Pilone</td></tr><tr><td>PR</td><td>Pavimento r√≠gido</td></tr><tr><td>PS</td><td>Passeio</td></tr><tr><td>SAP</td><td>Sapata</td></tr><tr><td>SH</td><td>Sinaliza√ß√£o Horizontal</td></tr><tr><td>SJ</td><td>Sarjeta</td></tr><tr><td>SV</td><td>Sinaliza√ß√£o Vertical</td></tr><tr><td>TA</td><td>Talude</td></tr><tr><td>TRE</td><td>Treli√ßa</td></tr><tr><td>TUB</td><td>Tubul√£o</td></tr><tr><td>V</td><td>V√£o</td></tr><tr><td>VA</td><td>Valeta</td></tr><tr><td>VL</td><td>Viga longarina</td></tr><tr><td>VLR</td><td>Viga longarina de rampa</td></tr><tr><td>VLT</td><td>Viga longarina de travessia</td></tr><tr><td>VT</td><td>Viga transversina</td></tr><tr><td>VTR</td><td>Viga travessa</td></tr><tr><td>VTRAV</td><td>Viga de travamento</td></tr></table></div></div></div>

    <!-- Input file oculto para importar planilha -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

    <!-- Input file oculto para importar planilha -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

    <!-- Input file oculto para importar planilha -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appState = { db: {}, activeInspecaoId: null, editingRecordId: null };
            const inspectionForm = document.getElementById('inspectionForm');
            const inspecaoAtivaSelect = document.getElementById('inspecaoAtiva');
            const novaInspecaoBtn = document.getElementById('novaInspecaoBtn');
            const deletarInspecaoBtn = document.getElementById('deletarInspecaoBtn');
            const getCoordsBtn = document.getElementById('getCoordsBtn');
            const copyCoordsContainer = document.getElementById('copyCoordsContainer');
            const coordsForCopyInput = document.getElementById('coordsForCopy');
            const copyCoordsBtn = document.getElementById('copyCoordsBtn');
            const registrosList = document.getElementById('registrosList');
            const exportButton = document.getElementById('exportButton');
            // Dados gerais + Caracter√≠sticas Gerais
            const dadosGeraisFields = {
                concessionaria: document.getElementById('concessionaria'),
                rodovia: document.getElementById('rodovia'),
                km: document.getElementById('km'),
                nome_obra: document.getElementById('nome_obra'),
                sentido: document.getElementById('sentido'),
                data: document.getElementById('data'),
                inspetor: document.getElementById('inspetor'),
                latitude: document.getElementById('latitude'),
                longitude: document.getElementById('longitude'),

                // Novos campos da aba Caracter√≠sticas Gerais
                comprimento_total: document.getElementById('comprimento_total'),
                largura_total: document.getElementById('largura_total'),
                largura_util: document.getElementById('largura_util'),
                sentido_crescente: document.getElementById('sentido_crescente'),
                qtd_vaos: document.getElementById('qtd_vaos'),
                pilares: document.getElementById('pilares'),
                juntas_dilatacao: document.getElementById('juntas_dilatacao'),
                vaos_tipo: document.getElementById('vaos_tipo'),
                tabuleiro_tipo: document.getElementById('tabuleiro_tipo'),
                tipologia_longitudinal: document.getElementById('tipologia_longitudinal'),
                tipologia_transversal: document.getElementById('tipologia_transversal'),
                tipologia_mesoestrutura: document.getElementById('tipologia_mesoestrutura'),
                tipologia_infraestrutura: document.getElementById('tipologia_infraestrutura'),
                sistemas_construtivos: document.getElementById('sistemas_construtivos'),
                natureza_transposicao: document.getElementById('natureza_transposicao'),
                materiais: document.getElementById('materiais'),
                qtd_aparelhos_apoio: document.getElementById('qtd_aparelhos_apoio'),
                gabarito_vertical_sob: document.getElementById('gabarito_vertical_sob'),
                gabarito_vertical_sobre: document.getElementById('gabarito_vertical_sobre'),
                gabarito_navegavel_altura: document.getElementById('gabarito_navegavel_altura'),
                gabarito_navegavel_largura: document.getElementById('gabarito_navegavel_largura')
            };
            const registroFields = { elemento: document.getElementById('elemento'), numero_elemento: document.getElementById('numero_elemento'), face: document.getElementById('face'), vao: document.getElementById('vao'), vista: document.getElementById('vista'), anomalia: document.getElementById('anomalia'), comprimento: document.getElementById('comprimento'), largura: document.getElementById('largura'), abertura: document.getElementById('abertura'), observacoes: document.getElementById('observacoes') };
            const tipoFotoSelect = document.getElementById('tipo_foto');
            const qtdFotosInput = document.getElementById('qtdFotos');
            const fotoInicialCameraInput = document.getElementById('fotoInicialCamera');
            const fotoInicialDroneInput = document.getElementById('fotoInicialDrone');
            const fotoInicialHidden = document.getElementById('fotoInicial');
            const fotoInfo = document.getElementById('fotoInfo');
            const modal = document.getElementById('legendaModal');
            const btnAbrirModal = document.getElementById('abrirModalLegendas');
            const spanCloseModal = document.querySelector('.close-button');
            const tabs = document.querySelectorAll('.tab');
            const submitBtn = document.getElementById('submitBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const anomaliaSelect = document.getElementById('anomalia');
            const anomaliaOptions = Array.from(anomaliaSelect.options);
            const filterButtons = document.querySelectorAll('#anomalia-filters .btn-filter');

            btnAbrirModal.onclick = () => { modal.style.display = "block"; };
            spanCloseModal.onclick = () => { modal.style.display = "none"; };
            window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

            const filterAnomalias = (category) => {
                anomaliaSelect.value = '';
                anomaliaOptions.forEach(option => {
                    if (option.value === '') { option.style.display = ''; return; }
                    const optionCategory = option.dataset.category;
                    option.style.display = (category === 'todos' || category === optionCategory) ? '' : 'none';
                });
                filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
            };
            filterButtons.forEach(button => button.addEventListener('click', () => filterAnomalias(button.dataset.category)));

            const loadDb = () => { appState.db = JSON.parse(localStorage.getItem('OAE_INSPECTIONS_DB')) || {}; };
            const saveDb = () => { localStorage.setItem('OAE_INSPECTIONS_DB', JSON.stringify(appState.db)); };

            const populateInspecaoSelector = () => {
                inspecaoAtivaSelect.innerHTML = '';
                const inspectionIds = Object.keys(appState.db).sort();
                if (inspectionIds.length === 0) { 
                    inspecaoAtivaSelect.innerHTML = '<option value="">Crie uma nova inspe√ß√£o</option>'; 
                    updateInspecoesList();
                    return; 
                }
                inspectionIds.forEach(id => { 
                    const option = document.createElement('option'); 
                    option.value = id; 
                    option.textContent = id; 
                    inspecaoAtivaSelect.appendChild(option); 
                });
                updateInspecoesList();
            };
            
            const updateInspecoesList = () => {
                const inspecoesList = document.getElementById('inspecoesList');
                const inspectionIds = Object.keys(appState.db).sort();
                
                if (inspectionIds.length === 0) {
                    inspecoesList.innerHTML = '<p style="text-align:center; color:#6c757d; padding: 20px;">Nenhuma inspe√ß√£o criada ainda.</p>';
                    return;
                }
                
                inspecoesList.innerHTML = '';
                inspectionIds.forEach(id => {
                    const inspecao = appState.db[id];
                    const item = document.createElement('div');
                    item.className = 'registro-item';
                    item.innerHTML = `
                        <div class="registro-item-header">
                            <h4>${id}</h4>
                            <div class="registro-item-actions">
                                <button class="btn btn-link" onclick="selectInspecao('${id}')">üìã</button>
                                <button class="btn btn-secondary" onclick="deleteInspecao('${id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <p><strong>Concession√°ria:</strong> ${inspecao.dadosGerais.concessionaria || 'N√£o informado'}</p>
                        <p><strong>Obra:</strong> ${inspecao.dadosGerais.nome_obra || 'N√£o informado'}</p>
                        <p><strong>Rodovia:</strong> ${inspecao.dadosGerais.rodovia || 'N√£o informado'}</p>
                        <p><strong>KM:</strong> ${inspecao.dadosGerais.km || 'N√£o informado'}</p>
                        <p><strong>Registros:</strong> ${inspecao.registros.length} item(s)</p>
                    `;
                    inspecoesList.appendChild(item);
                });
            };
            
            const updateTabStates = () => {
                const hasActiveInspecao = !!appState.activeInspecaoId;
                tabs.forEach(tab => { if (tab.dataset.tab !== 'inspecoes') tab.disabled = !hasActiveInspecao; });
            };

            const setActiveInspecao = (id) => {
                appState.activeInspecaoId = id;
                updateTabStates();
                if(cancelEditBtn.offsetParent !== null) cancelEditBtn.click();
                if (!id) {
                    Object.values(dadosGeraisFields).forEach(field => field.value = '');
                    dadosGeraisFields.data.value = new Date().toISOString().split('T')[0];
                    loadRegistros([]);
                    copyCoordsContainer.classList.add('hidden');
                    return;
                }
                const inspecao = appState.db[id];
                if (!inspecao) return;
                
                // Preencher campos de dados gerais e caracter√≠sticas gerais
                for (const key in inspecao.dadosGerais) { 
                    if (dadosGeraisFields[key]) {
                        dadosGeraisFields[key].value = inspecao.dadosGerais[key] || '';
                    }
                }
                
                // Configurar coordenadas se existirem
                if(inspecao.dadosGerais.latitude && inspecao.dadosGerais.longitude){
                    coordsForCopyInput.value = `${inspecao.dadosGerais.latitude}, ${inspecao.dadosGerais.longitude}`;
                    copyCoordsContainer.classList.remove('hidden');
                } else {
                    copyCoordsContainer.classList.add('hidden');
                }
                
                // Configurar contadores de fotos
                fotoInicialCameraInput.value = inspecao.contadores.camera;
                fotoInicialDroneInput.value = inspecao.contadores.drone;
                toggleContadorInputs();
                loadRegistros(inspecao.registros);
            };

            const saveActiveInspecaoData = () => {
                if (!appState.activeInspecaoId) return;
                const inspecao = appState.db[appState.activeInspecaoId];
                if (!inspecao) return;
                for (const key in dadosGeraisFields) { inspecao.dadosGerais[key] = dadosGeraisFields[key].value; }
                saveDb();
            };

            const loadRegistros = (registros = []) => {
                registrosList.innerHTML = '';
                if (registros.length === 0) { registrosList.innerHTML = '<p style="text-align:center; color:#6c757d; padding: 20px;">Nenhum registro para esta inspe√ß√£o.</p>'; return; }
                registros.slice().reverse().forEach(registro => {
                    const fotoFinal = parseInt(registro.fotoInicial) + parseInt(registro.qtdFotos) - 1;
                    const item = document.createElement('div');
                    item.className = 'registro-item';
                    item.innerHTML = `<div class="registro-item-header"><h4>${registro.elemento} ${registro.numero_elemento}</h4><div class="registro-item-actions"><button class="btn btn-link" onclick="duplicateRegistro('${registro.id}')">üìÑ</button><button class="btn btn-link" onclick="editRegistro('${registro.id}')">‚úèÔ∏è</button><button class="btn btn-secondary" onclick="deleteRegistro('${registro.id}')">üóëÔ∏è</button></div></div><p><strong>Anomalia:</strong> ${registro.anomalia}</p><p><strong>Fotos (${registro.tipo_foto}):</strong> ${registro.fotoInicial} a ${fotoFinal}</p>`;
                    registrosList.appendChild(item);
                });
            };
            
            window.deleteRegistro = (id) => {
                if (!appState.activeInspecaoId || !confirm('Tem certeza?')) return;
                const inspecao = appState.db[appState.activeInspecaoId];
                inspecao.registros = inspecao.registros.filter(r => r.id != id);
                saveDb();
                loadRegistros(inspecao.registros);
            };
            
            window.selectInspecao = (id) => {
                inspecaoAtivaSelect.value = id;
                setActiveInspecao(id);
                showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]'));
            };
            
            window.deleteInspecao = (id) => {
                if (!confirm(`Tem certeza que deseja DELETAR PERMANENTEMENTE a inspe√ß√£o "${id}" e todos os seus registros?`)) return;
                delete appState.db[id];
                saveDb();
                populateInspecaoSelector();
                const firstInspecaoId = Object.keys(appState.db)[0] || null;
                setActiveInspecao(firstInspecaoId);
                if (firstInspecaoId) inspecaoAtivaSelect.value = firstInspecaoId;
            };

            const populateFormWithRecord = (id) => {
                const inspecao = appState.db[appState.activeInspecaoId];
                const record = inspecao.registros.find(r => r.id === id);
                if (!record) return;
                filterAnomalias('todos');
                for(const key in registroFields) {
                    if(key === 'anomalia'){
                        const option = Array.from(anomaliaSelect.options).find(opt => opt.textContent === record.anomalia);
                        anomaliaSelect.value = option ? option.value : "";
                    } else if (record[key] !== undefined) {
                        registroFields[key].value = record[key];
                    }
                }
                tipoFotoSelect.value = record.tipo_foto;
                qtdFotosInput.value = record.qtdFotos;
                fotoInicialCameraInput.value = record.fotoInicial;
                fotoInicialDroneInput.value = record.fotoInicial;
                toggleContadorInputs();
            };

            window.editRegistro = (id) => {
                appState.editingRecordId = id;
                populateFormWithRecord(id);
                submitBtn.textContent = 'üíæ Atualizar Registro';
                cancelEditBtn.classList.remove('hidden');
                showTab('registros', document.querySelector('.tab[data-tab="registros"]'));
                inspectionForm.scrollIntoView({ behavior: 'smooth' });
            };

            window.duplicateRegistro = (id) => {
                appState.editingRecordId = null;
                const inspecao = appState.db[appState.activeInspecaoId];
                const record = inspecao.registros.find(r => r.id === id);
                if (!record) return;
                populateFormWithRecord(id);
                submitBtn.textContent = 'üíæ Salvar Registro';
                cancelEditBtn.classList.add('hidden');
                const tipoFoto = tipoFotoSelect.value;
                if(tipoFoto === 'camera') fotoInicialCameraInput.value = inspecao.contadores.camera;
                else fotoInicialDroneInput.value = inspecao.contadores.drone;
                updatePhotoInfo();
                inspectionForm.scrollIntoView({ behavior: 'smooth' });
                alert("Registro duplicado. Altere o necess√°rio e salve como um novo registro.");
            };

            cancelEditBtn.addEventListener('click', () => {
                appState.editingRecordId = null;
                submitBtn.textContent = 'üíæ Salvar Registro';
                cancelEditBtn.classList.add('hidden');
                inspectionForm.reset();
                const inspecao = appState.db[appState.activeInspecaoId];
                if(inspecao) {
                    fotoInicialCameraInput.value = inspecao.contadores.camera;
                    fotoInicialDroneInput.value = inspecao.contadores.drone;
                }
                toggleContadorInputs();
            });

            inspecaoAtivaSelect.addEventListener('change', () => {
                saveActiveInspecaoData();
                setActiveInspecao(inspecaoAtivaSelect.value);
            });

            novaInspecaoBtn.addEventListener('click', () => {
                const rodovia = prompt("Digite a Rodovia (ex: BR-101):");
                const km = prompt("Digite o KM (ex: 50+300):");
                if (!rodovia || !km) return alert("Rodovia e KM s√£o obrigat√≥rios.");
                const newId = `${rodovia.trim()}_${km.trim()}`.replace(/ /g, '_');
                if (appState.db[newId]) return alert("Uma inspe√ß√£o com essa Rodovia e KM j√° existe.");
                appState.db[newId] = { dadosGerais: { rodovia, km, data: new Date().toISOString().split('T')[0], inspetor: '', concessionaria: '', nome_obra: '', sentido: '', latitude: '', longitude: '' }, contadores: { camera: 1, drone: 1 }, registros: [] };
                saveDb();
                populateInspecaoSelector();
                inspecaoAtivaSelect.value = newId;
                setActiveInspecao(newId);
                alert(`Nova inspe√ß√£o "${newId}" criada. V√° para a aba 'Dados Gerais' para preencher o resto das informa√ß√µes.`);
                showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]'));
            });

            deletarInspecaoBtn.addEventListener('click', () => {
                if (!appState.activeInspecaoId) return alert("Nenhuma inspe√ß√£o selecionada.");
                if (!confirm(`Tem certeza que deseja DELETAR PERMANENTEMENTE a inspe√ß√£o "${appState.activeInspecaoId}" e todos os seus registros?`)) return;
                delete appState.db[appState.activeInspecaoId];
                saveDb();
                populateInspecaoSelector();
                const firstInspecaoId = Object.keys(appState.db)[0] || null;
                setActiveInspecao(firstInspecaoId);
                if (firstInspecaoId) inspecaoAtivaSelect.value = firstInspecaoId;
            });
            
            Object.values(dadosGeraisFields).forEach(field => field.addEventListener('blur', saveActiveInspecaoData));

            getCoordsBtn.addEventListener('click', () => {
                if (!("geolocation" in navigator)) { alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador."); return; }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        dadosGeraisFields.latitude.value = lat.toFixed(7);
                        dadosGeraisFields.longitude.value = lon.toFixed(7);
                        coordsForCopyInput.value = `${lat.toFixed(7)}, ${lon.toFixed(7)}`;
                        copyCoordsContainer.classList.remove('hidden');
                        saveActiveInspecaoData();
                        alert('Coordenadas obtidas com sucesso!');
                    },
                    (error) => {
                        let errorMsg = "Ocorreu um erro desconhecido.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMsg = "Permiss√£o para acessar a localiza√ß√£o foi negada."; break;
                            case error.POSITION_UNAVAILABLE: errorMsg = "A informa√ß√£o de localiza√ß√£o n√£o est√° dispon√≠vel."; break;
                            case error.TIMEOUT: errorMsg = "A requisi√ß√£o para obter a localiza√ß√£o expirou."; break;
                        }
                        alert(errorMsg);
                    }
                );
            });

            copyCoordsBtn.addEventListener('click', () => {
                coordsForCopyInput.select();
                document.execCommand('copy');
                alert('Coordenadas copiadas para a √°rea de transfer√™ncia!');
            });

            const updatePhotoInfo = () => {
                const tipoAtual = tipoFotoSelect.value;
                const numInicial = (tipoAtual === 'camera') ? parseInt(fotoInicialCameraInput.value) : parseInt(fotoInicialDroneInput.value);
                const qtd = parseInt(qtdFotosInput.value) || 0;
                const numFinal = isNaN(numInicial) || isNaN(qtd) ? '' : numInicial + qtd - 1;
                fotoInicialHidden.value = numInicial;
                fotoInfo.textContent = `Fotos (${tipoAtual}): ${numInicial || '?'} a ${numFinal || '?'}`;
            };

            const toggleContadorInputs = () => {
                document.getElementById('contador_camera_group').classList.toggle('hidden', tipoFotoSelect.value !== 'camera');
                document.getElementById('contador_drone_group').classList.toggle('hidden', tipoFotoSelect.value !== 'drone');
                updatePhotoInfo();
            };
            
            tipoFotoSelect.addEventListener('change', toggleContadorInputs);
            [qtdFotosInput, fotoInicialCameraInput, fotoInicialDroneInput].forEach(input => input.addEventListener('input', updatePhotoInfo));
            
            const updateContadorStorage = (tipo, valor) => {
                if (!appState.activeInspecaoId) return;
                const inspecao = appState.db[appState.activeInspecaoId];
                if (inspecao && !appState.editingRecordId) { inspecao.contadores[tipo] = parseInt(valor) || 1; saveDb(); }
            };
            fotoInicialCameraInput.addEventListener('change', () => updateContadorStorage('camera', fotoInicialCameraInput.value));
            fotoInicialDroneInput.addEventListener('change', () => updateContadorStorage('drone', fotoInicialDroneInput.value));

            inspectionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!appState.activeInspecaoId) { alert("Nenhuma inspe√ß√£o ativa. Crie ou selecione uma inspe√ß√£o primeiro."); return; }
                saveActiveInspecaoData();
                const inspecao = appState.db[appState.activeInspecaoId];
                const formData = new FormData(inspectionForm);
                let newRecordData = {};
                formData.forEach((value, key) => { newRecordData[key] = value; });

                if (appState.editingRecordId) {
                    const recordIndex = inspecao.registros.findIndex(r => r.id === appState.editingRecordId);
                    if (recordIndex > -1) {
                        const originalRecord = inspecao.registros[recordIndex];
                        inspecao.registros[recordIndex] = { ...originalRecord, ...newRecordData };
                        let anomaliaField = inspecao.registros[recordIndex].anomalia;
                        if (!anomaliaField) { inspecao.registros[recordIndex].anomalia = "Foto Geral"; }
                        else {
                            const anomaliaOption = document.querySelector(`#anomalia option[value="${anomaliaField}"]`);
                            if(anomaliaOption) inspecao.registros[recordIndex].anomalia = anomaliaOption.textContent;
                        }
                    }
                    alert('Registro atualizado com sucesso!');
                    cancelEditBtn.click();
                } else {
                    newRecordData.id = Date.now().toString();
                    if (!newRecordData.anomalia) { newRecordData.anomalia = "Foto Geral"; }
                    else {
                        const anomaliaOption = document.querySelector(`#anomalia option[value="${newRecordData.anomalia}"]`);
                        if(anomaliaOption) newRecordData.anomalia = anomaliaOption.textContent;
                    }
                    inspecao.registros.push(newRecordData);
                    const tipoFoto = newRecordData.tipo_foto;
                    const novoContador = parseInt(newRecordData.fotoInicial) + parseInt(newRecordData.qtdFotos);
                    inspecao.contadores[tipoFoto] = novoContador;
                    if (tipoFoto === 'camera') { fotoInicialCameraInput.value = novoContador; } else { fotoInicialDroneInput.value = novoContador; }
                    alert('Registro salvo com sucesso!');
                }
                saveDb();
                Object.values(registroFields).forEach(field => { if(field.tagName === 'SELECT') field.selectedIndex = 0; else field.value = ''; });
                updatePhotoInfo();
                loadRegistros(inspecao.registros);
            });
            
            exportButton.addEventListener('click', () => {
                if (!appState.activeInspecaoId) { alert("Nenhuma inspe√ß√£o ativa para exportar."); return; }
                const inspecao = appState.db[appState.activeInspecaoId];
                const registros = inspecao.registros;
                if (registros.length === 0) { alert('Nenhum registro para exportar nesta inspe√ß√£o.'); return; }
                const customElementOrder = ["AD","V","L","LI","LS","JANELA","LT","LB","BL","AB","VL","ALE","ALI","CABO DE PROTENS√ÉO","TUBO ARMCO","CEL","DG","VLR","BLOCO DE ANCORAGEM","VLT","BZ","DI","MT","VT","EB","TESTEIRA","TRE","TRAVESSIA","JUNTA","RAMPA","AA","BER√áO","VTR","VTRAV","P","PA","PIL","AP","BLC","TUB","ET","SAP","ENC","CO","AL","TA","PISTA","TRECHO","PC","PF","PR","JD","SH-TACHAS REFLETIVAS","SV-BARREIRAS","SV-GABARITO","BR","GC","PLACA DE FECHAMENTO","DM","GR","DR","PINGADEIRA","PS","JUSANTE","MONTANTE","TUBULA√á√ÉO DE UTILIDADE","BUZ","BU","MF","SJ","VA","AC", "FOTO CAPA PANOR√ÇMICA", "FINAL DE INSPE√á√ÉO"];
                const sortedRegistros = [...registros].sort((a, b) => {
                    const isAGeral = a.anomalia === 'Foto Geral';
                    const isBGeral = b.anomalia === 'Foto Geral';
                    if (isAGeral && !isBGeral) return -1;
                    if (!isAGeral && isBGeral) return 1;
                    const indexA = customElementOrder.indexOf(a.elemento);
                    const indexB = customElementOrder.indexOf(b.elemento);
                    const finalIndexA = indexA === -1 ? Infinity : indexA;
                    const finalIndexB = indexB === -1 ? Infinity : indexB;
                    if (finalIndexA !== finalIndexB) return finalIndexA - finalIndexB;
                    const numA = parseInt(a.numero_elemento, 10) || 0;
                    const numB = parseInt(b.numero_elemento, 10) || 0;
                    return numA - numB;
                });
                const headers = [
                    'ID','Concession√°ria','Rodovia','KM','Latitude','Longitude',
                    'Nome da Obra','Sentido','Data','Inspetor',
                    'Comprimento total (m)','Largura total (m)','Largura √∫til (m)','Sentido crescente',
                    'Quantidade de v√£os','Pilares','Juntas de dilata√ß√£o','V√£os‚Äëtipo','Tabuleiro‚Äëtipo',
                    'Tipologia longitudinal (Superestrutura)','Tipologia transversal (Superestrutura)',
                    'Tipologia da mesoestrutura','Tipologia da infraestrutura',
                    'Sistemas construtivos','Natureza da transposi√ß√£o','Materiais',
                    'Quantidade de aparelhos de apoio','Gabarito vertical sob a OAE (m)',
                    'Gabarito vertical sobre a OAE (m)',
                    'Gabarito naveg√°vel ‚Äî Altura (m)','Gabarito naveg√°vel ‚Äî Largura (m)',
                    'Elemento','N√∫mero do Elemento','Face','V√£o','Vista','Anomalia',
                    'Comprimento (m)','Largura (m)','Abertura Fissura','Tipo de Foto',
                    'Foto Inicial','Foto Final','Qtd Fotos','Observa√ß√µes'
                ];
                const data = sortedRegistros.map(r => {
                    const cleanedObservacoes = (r.observacoes || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const fotoFinal = parseInt(r.fotoInicial) + parseInt(r.qtdFotos) - 1;
                    const rowData = { ...inspecao.dadosGerais, ...r };
                    return [
                        rowData.id,
                        rowData.concessionaria, rowData.rodovia, rowData.km, rowData.latitude, rowData.longitude,
                        rowData.nome_obra, rowData.sentido, rowData.data, rowData.inspetor,
                        rowData.comprimento_total, rowData.largura_total, rowData.largura_util, rowData.sentido_crescente,
                        rowData.qtd_vaos, rowData.pilares, rowData.juntas_dilatacao, rowData.vaos_tipo, rowData.tabuleiro_tipo,
                        rowData.tipologia_longitudinal, rowData.tipologia_transversal, rowData.tipologia_mesoestrutura,
                        rowData.tipologia_infraestrutura, rowData.sistemas_construtivos, rowData.natureza_transposicao,
                        rowData.materiais, rowData.qtd_aparelhos_apoio, rowData.gabarito_vertical_sob,
                        rowData.gabarito_vertical_sobre, rowData.gabarito_navegavel_altura, rowData.gabarito_navegavel_largura,
                        rowData.elemento, rowData.numero_elemento, rowData.face, rowData.vao, rowData.vista,
                        rowData.anomalia, rowData.comprimento || '', rowData.largura || '', rowData.abertura || '',
                        rowData.tipo_foto, rowData.fotoInicial, fotoFinal, rowData.qtdFotos, cleanedObservacoes
                    ];
                });
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Registros");
                const nomeArquivo = `inspecao_${appState.activeInspecaoId}`.replace(/[^a-zA-Z0-9\-_]/g, '_');
                XLSX.writeFile(wb, `${nomeArquivo}.xlsx`);
            });
            
            // Fun√ß√µes para importar/exportar planilha
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            const importDataBtn = document.getElementById('importDataBtn');
            const fileInput = document.getElementById('fileInput');
            const importStatus = document.getElementById('importStatus');
            const importMessage = document.getElementById('importMessage');

            // Gerar planilha modelo
            downloadTemplateBtn.addEventListener('click', () => {
                const headers = ['Concession√°ria', 'Nome da Obra', 'Rodovia', 'KM+M'];
                const sampleData = [
                    ['Concession√°ria Exemplo', 'Obra Exemplo', 'BR-101', '50+300'],
                    ['', '', '', ''], // Linha em branco para preenchimento
                    ['', '', '', ''], // Linha em branco para preenchimento
                    ['', '', '', ''], // Linha em branco para preenchimento
                    ['', '', '', '']  // Linha em branco para preenchimento
                ];

                const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados Gerais");
                
                // Ajustar largura das colunas
                ws['!cols'] = [
                    { width: 20 }, // Concession√°ria
                    { width: 25 }, // Nome da Obra
                    { width: 15 }, // Rodovia
                    { width: 15 }  // KM+M
                ];

                XLSX.writeFile(wb, 'modelo_dados_gerais.xlsx');
            });

            // Importar planilha
            importDataBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // Validar cabe√ßalhos
                        const expectedHeaders = ['Concession√°ria', 'Nome da Obra', 'Rodovia', 'KM+M'];
                        const headers = jsonData[0];
                        
                        if (!headers || headers.length < 4) {
                            showImportMessage('‚ùå Formato inv√°lido. Use a planilha modelo.', 'error');
                            return;
                        }

                        // Verificar se os cabe√ßalhos est√£o corretos
                        const isValidFormat = expectedHeaders.every((header, index) => 
                            headers[index] && headers[index].toString().toLowerCase().includes(header.toLowerCase())
                        );

                        if (!isValidFormat) {
                            showImportMessage('‚ùå Cabe√ßalhos inv√°lidos. Use a planilha modelo.', 'error');
                            return;
                        }

                        // Processar dados
                        let importedCount = 0;
                        let skippedCount = 0;

                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length < 4) continue;

                            const concessionaria = row[0] || '';
                            const nomeObra = row[1] || '';
                            const rodovia = row[2] || '';
                            const km = row[3] || '';

                            // Validar dados obrigat√≥rios
                            if (!rodovia || !km) {
                                skippedCount++;
                                continue;
                            }

                            // Criar ID √∫nico
                            const newId = `${rodovia.trim()}_${km.trim()}`.replace(/ /g, '_');
                            
                            // Verificar se j√° existe
                            if (appState.db[newId]) {
                                skippedCount++;
                                continue;
                            }

                            // Criar nova inspe√ß√£o
                            appState.db[newId] = {
                                dadosGerais: {
                                    concessionaria: concessionaria,
                                    nome_obra: nomeObra,
                                    rodovia: rodovia,
                                    km: km,
                                    data: new Date().toISOString().split('T')[0],
                                    inspetor: '',
                                    sentido: '',
                                    latitude: '',
                                    longitude: '',
                                    // Todos os campos de caracter√≠sticas iniciam em branco
                                    comprimento_total: '',
                                    largura_total: '',
                                    largura_util: '',
                                    sentido_crescente: '',
                                    qtd_vaos: '',
                                    pilares: '',
                                    juntas_dilatacao: '',
                                    vaos_tipo: '',
                                    tabuleiro_tipo: '',
                                    tipologia_longitudinal: '',
                                    tipologia_transversal: '',
                                    tipologia_mesoestrutura: '',
                                    tipologia_infraestrutura: '',
                                    sistemas_construtivos: '',
                                    natureza_transposicao: '',
                                    materiais: '',
                                    qtd_aparelhos_apoio: '',
                                    gabarito_vertical_sob: '',
                                    gabarito_vertical_sobre: '',
                                    gabarito_navegavel_altura: '',
                                    gabarito_navegavel_largura: ''
                                },
                                contadores: { camera: 1, drone: 1 },
                                registros: []
                            };

                            importedCount++;
                        }

                        saveDb();
                        populateInspecaoSelector();
                        
                        if (importedCount > 0) {
                            showImportMessage(`‚úÖ ${importedCount} inspe√ß√£o(√µes) importada(s) com sucesso!${skippedCount > 0 ? ` ${skippedCount} linha(s) ignorada(s).` : ''}`, 'success');
                            
                            // Selecionar automaticamente a primeira inspe√ß√£o importada
                            const importedIds = Object.keys(appState.db).filter(id => {
                                const inspecao = appState.db[id];
                                return inspecao.dadosGerais.rodovia && inspecao.dadosGerais.km;
                            });
                            
                            if (importedIds.length > 0) {
                                const firstImportedId = importedIds[0];
                                inspecaoAtivaSelect.value = firstImportedId;
                                setActiveInspecao(firstImportedId);
                                
                                // Mostrar aba de dados gerais
                                showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]'));
                            }
                        } else {
                            showImportMessage('‚ö†Ô∏è Nenhuma inspe√ß√£o foi importada. Verifique os dados.', 'warning');
                        }

                        // Limpar input
                        fileInput.value = '';

                    } catch (error) {
                        console.error('Erro ao importar:', error);
                        showImportMessage('‚ùå Erro ao processar o arquivo. Verifique o formato.', 'error');
                    }
                };

                reader.readAsArrayBuffer(file);
            });

            function showImportMessage(message, type) {
                importMessage.textContent = message;
                importMessage.style.color = type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#dc3545';
                importMessage.style.background = type === 'success' ? '#d4edda' : type === 'warning' ? '#fff3cd' : '#f8d7da';
                importStatus.style.display = 'block';
                
                // Esconder ap√≥s 5 segundos
                setTimeout(() => {
                    importStatus.style.display = 'none';
                }, 5000);
            }

            const initApp = () => {
                loadDb();
                populateInspecaoSelector();
                const firstInspecaoId = Object.keys(appState.db)[0] || null;
                if(firstInspecaoId) inspecaoAtivaSelect.value = firstInspecaoId;
                setActiveInspecao(firstInspecaoId);
            };

            initApp();

            // Fun√ß√£o para deletar todas as inspe√ß√µes
            const deletarTudoBtn = document.getElementById('deletarTudoBtn');
            if (deletarTudoBtn) {
                deletarTudoBtn.addEventListener('click', () => {
                    if (confirm('Tem certeza que deseja DELETAR TODAS AS INSPE√á√ïES? Esta a√ß√£o √© irrevers√≠vel!')) {
                        localStorage.removeItem('OAE_INSPECTIONS_DB');
                        location.reload();
                    }
                });
            }
        });

        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            element.classList.add('active');
        }
    </script>
    <script>
// Registro e gerenciamento do Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js')
      .then(function(registration) {
        console.log('Service Worker registrado com sucesso:', registration.scope);
        
        // Verifica se h√° uma nova vers√£o do Service Worker
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nova vers√£o dispon√≠vel
              if (confirm('Uma nova vers√£o do aplicativo est√° dispon√≠vel. Deseja atualizar agora?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
        
        // Atualiza a p√°gina quando o Service Worker assume controle
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('Novo Service Worker assumiu controle');
        });
      })
      .catch(function(err) {
        console.log('Falha ao registrar o Service Worker:', err);
      });
  });
}

// Fun√ß√£o para verificar se o aplicativo est√° funcionando offline
function checkOfflineStatus() {
  const offlineIndicator = document.getElementById('offlineIndicator');
  if (!navigator.onLine) {
    console.log('Aplicativo funcionando offline');
    if (offlineIndicator) {
      offlineIndicator.style.display = 'block';
    }
  } else {
    if (offlineIndicator) {
      offlineIndicator.style.display = 'none';
    }
  }
}

// Adiciona listeners para mudan√ßas de conectividade
window.addEventListener('online', () => {
  console.log('Conex√£o restaurada');
  const offlineIndicator = document.getElementById('offlineIndicator');
  if (offlineIndicator) {
    offlineIndicator.style.display = 'none';
  }
});

window.addEventListener('offline', () => {
  console.log('Aplic aplicativo funcionando offline');
  const offlineIndicator = document.getElementById('offlineIndicator');
  if (offlineIndicator) {
    offlineIndicator.style.display = 'block';
  }
});

// Verifica status inicial
checkOfflineStatus();
</script>
</body>
</html>
